<h4 class="small-title" style="margin-top: 30px">RESERVATIONS FACTURABLES</h4>

<% if @billable_lessons.select {|l| l.invoice.nil?}.present? %>
  <a class="btn btn-info btn-perspective" href="<%= admin_generate_invoices_path %>" style="margin-bottom: 30px"><i class="fa fa-plus"></i> Facturer toutes les réservations</a>
<% end %>

<% if Invoice.all.where("sending_date IS NULL").present? %>
  <a class="btn btn-primary btn-perspective" href="<%= admin_send_invoices_path %>" style="margin-bottom: 30px"><i class="fa fa-envelope-o"></i> Envoyer toutes les factures</a>
<% end %>

<div class="the-box">
  <div class="table-responsive">
    <table class="table table-striped table-hover datatable" id="lessons-datatable">
      <thead class="the-box dark full">
        <tr>
          <th style="width:100px">Actions</th>
          <th>Code</th>
          <th>Date du cours</th>
          <th>Type de cours</th>
          <th>Professeur</th>
          <th>Elève</th>
          <th>Montant total</th>
          <th>Payement</th>
          <th>Facture</th>
                  </tr>
      </thead>
      <tbody id="lessons_data">
        <% @billable_lessons.each do |lesson| %>
          <tr id="lessons_<%= lesson.id %>">
            <td>
              <a class="btn btn-info" href="<%= edit_admin_lesson_path(lesson) %>"><i class="fa fa-pencil"></i></a>
              <% if lesson.invoice_id.nil? %>
                <a class="btn btn-danger delete-record" data-id="<%= lesson.id %>" data-type="lessons"><i class="fa fa-trash-o"></i></a>
              <% end %>
            </td>
            <td><%= lesson.code %></td>
            <td><%= lesson.invoice_date.strftime("%d/%m/%Y") if lesson.invoice_date.present? %></td>
            <td><%= lesson.item_sold %></td>
            <td><%= lesson.teacher_name %></td>
            <td><%= lesson.student.name if lesson.student.present? %></td>
            <td><%= lesson.full_price - lesson.discount %></td>
            <td><%= lesson.get_payment_status %></td>
            <td><%= lesson.invoice.present? ? (lesson.invoice.sending_date.present? ? "Facture envoyée le #{lesson.invoice.sending_date.strftime("%d/%m/%Y")}" :  "Facture créée le #{lesson.invoice.created_at.strftime("%d/%m/%Y")}") : "Non encore créée" %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>